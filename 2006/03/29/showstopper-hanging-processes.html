<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/theme.js"></script>
<link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/css/theme.css" rel="stylesheet" type="text/css">
<link href="/css/syntax.css" rel="stylesheet" type="text/css">



    <title>Third Bit: Showstopper: Hanging Processes</title>
  </head>
  <body>
    <div class="container-fluid">
  <div class="row-fluid">
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Third Bit</a>
      </div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <li class="active visible-xs-block"><a href="/links/">Links</a></li>
          <li class="active"><a href="/about/">About</a></li>
          <li class="active"><a href="/talks/">Talks</a></li>
          <li class="active"><a href="/ideas/">Ideas</a></li>
          <li class="active"><a href="/reading/">Reading</a></li>
          <li class="active"><a href="/archive/">Archive</a></li>
          <li class="active"><a href="/teaching/"><em>How to Teach</em></a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li class="active"><a href="http://appear.in/gvwilson"><img src="/files/appear.in.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="https://github.com/gvwilson"><img src="/files/github.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="http://twitter.com/gvwilson"><img src="/files/twitter.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="/feed.xml"><img src="/files/rss.svg" class="navbar-icon" /></a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

    <div class="container container-left">
      <div class="row">
        <div class="col-md-3 hidden-xs">
          <div class="sidebar well">
  <h2>Links</h2>
<p><em><a href="http://software-carpentry.org">Software Carpentry</a></em></p>
<p><em><a href="http://aosabook.org">Architecture of Open Source Applications</a></em></p>
<p><em><a href="http://neverworkintheory.org">Never Work in Theory</a></em></p>
<p><em><a href="http://sensibleadventures.com">Sensible Adventures</a></em></p>
<p><a href="/cv/">CV</a></p>
<p><a href="/bib/">Bibliography</a></p>

  <h2>Favorites</h2>
  
  
  <p><a href="/2018/03/20/goodbye-jeff.html">Goodbye, Jeff</a></p>
  
  <p><a href="/2018/03/16/seven-ways.html">Seven Ways to Think Like a Programmer</a></p>
  
  <p><a href="/2018/03/13/base-case-for-empirical-software-engineering.html">A Base Case for Empirical Software Engineering Research</a></p>
  
  <p><a href="/2018/01/07/book-club.html">Book Club</a></p>
  
  <p><a href="/2017/12/21/talking-people-into-things.html">Ten Simple Rules for Talking People Into Things</a></p>
  
  <p><a href="/2017/11/05/for-everyone.html">Carpentry For Everyone</a></p>
  
  <p><a href="/2017/10/16/exercise-types.html">What Kinds of Exercises Do You Use to Teach Programming?</a></p>
  
  <p><a href="/2017/09/30/git-graphs-and-engineering.html">Git, Graphs, and Software Engineering</a></p>
  
  <p><a href="/2017/06/19/ten-rules-research-partner.html">Ten Simple Rules for Being a Good Research Partner</a></p>
  
  <p><a href="/2017/05/22/numerical-javascript.html">Numerical JavaScript</a></p>
  
  <p><a href="/2017/01/06/them-thats-got.html">Them That's Got</a></p>
  
  <p><a href="/2016/10/30/rules-for-teaching.html">Rules for Teaching</a></p>
  
  <p><a href="/2016/04/29/why-teachers-dont-collaborate.html">Why Teachers Don't Collaborate on Lesson Development</a></p>
  
  <p><a href="/2016/04/01/zen-and-the-art-of-assignment-operators.html">Zen and the Art of Assignment Operators</a></p>
  
  <p><a href="/2016/03/13/in-my-better-world.html">In My Better World</a></p>
  
  <p><a href="/2015/12/19/why-i-teach.html">Why I Teach (Revisited)</a></p>
  
  <p><a href="/2015/12/06/just-keep-swimming.html">Just Keep Swimming</a></p>
  
  <p><a href="/2015/11/29/exaptation.html">Exaptation and the Future of Software Engineering</a></p>
  
  <p><a href="/2015/11/09/daddy-why-dont-you-ever-laugh.html">Daddy, Why Don't You Ever Laugh?</a></p>
  
  <p><a href="/2015/09/22/dad.html">Goodbye, Dad</a></p>
  
  <p><a href="/2014/10/08/announcing-the-creation-of-the-software-carpentry-foundational.html">Announcing the Creation of the Software Carpentry Foundation</a></p>
  
  <p><a href="/2014/03/14/learning-at-scale.html">Is Learning at Scale Just Another Name for Ubiquitous Surveillance in the Classroom?</a></p>
  
  <p><a href="/2013/10/17/you-keep-using-that-word.html">You Keep Using That Word</a></p>
  
  <p><a href="/2013/02/11/correctness-isnt-compelling.html">Correctness Isn't Compelling</a></p>
  
  <p><a href="/2012/10/23/twenty-percent.html">Twenty Percent</a></p>
  
  <p><a href="/2012/06/29/those-who-ignore-history.html">That Seems Simple to Me</a></p>
  
  <p><a href="/2012/01/21/the-life-i-did-live-the-breath-i-breathed.html">We Have Nothing To Give Them</a></p>
  
</div>

        </div>
        <div class="col-md-9">
          <div class="article">
            <div class="well">
              <h1><a href="/2006/03/29/showstopper-hanging-processes.html">Mar 29, 2006 - Showstopper: Hanging Processes</a></h1>
              <div class="post-content">
                We've run into a rather annoying bug in <a href="http://www.third-bit.com/drproject/drproject-dev">DrProject</a>. I've been keeping some brief notes in this <a href="http://www.third-bit.com/drproject/drproject-dev/ticket/233">ticket</a>, but I'll try to organize my thoughts better here.

First, some background.  DrProject is run as a cgi script under Apache and is backed by PostgreSQL.  Every so often (almost daily), we notice that a number of python/postgres processes are hung:
<blockquote>
<pre>www-data 32016  0.0  1.1 18112 12344 ?       S    06:24   0:02 python2.4 drproject.cgi postgres 32017  0.0  0.6 17880 7148 ?        S    06:24   0:00 postgres: www-data drprojectdb-svn 127.0.0.1 idle in transaction www-data 32203  0.0  1.1 18112 12344 ?       S    06:31   0:02 python2.4 drproject.cgi postgres 32204  0.0  0.6 17880 7160 ?        S    06:31   0:00 postgres: www-data drprojectdb-svn 127.0.0.1 idle in transaction www-data 32279  0.0  1.1 18112 12344 ?       S    06:38   0:02 python2.4 drproject.cgi postgres 32281  0.0  0.7 17916 7476 ?        S    06:38   0:00 postgres: www-data drprojectdb-svn 127.0.0.1 idle in transaction www-data 32340  0.0  1.1 18112 12340 ?       S    06:44   0:02 python2.4 drproject.cgi postgres 32341  0.0  0.7 17916 7316 ?        S    06:44   0:00 postgres: www-data drprojectdb-svn 127.0.0.1 idle in transaction www-data 32410  0.0  1.1 18112 12344 ?       S    06:52   0:02 python2.4 drproject.cgi postgres 32411  0.0  0.6 17880 7148 ?        S    06:52   0:00 postgres: www-data drprojectdb-svn 127.0.0.1 idle in transaction www-data 32466  0.0  1.1 18112 12344 ?       S    06:57   0:02 python2.4 drproject.cgi postgres 32467  0.0  0.7 17916 7308 ?        S    06:57   0:00 postgres: www-data drprojectdb-svn 127.0.0.1 idle in transaction www-data 32533  0.0  1.1 18112 12344 ?       S    07:04   0:02 python2.4 drproject.cgi postgres 32534  0.0  0.6 17880 7160 ?        S    07:04   0:00 postgres: www-data drprojectdb-svn 127.0.0.1 idle in transaction ...</pre>
</blockquote>
As these processes build up, eventually the number of active postgres connections exceeds the number of allowable non-superuser connections, requiring us to manually kill these processes.

I have been unable to find a sequence of steps to reproduce the frozen processes, but I've been able to run a few short tests when it has occurred:
<ul>
	<li>When the process hangs, it is due to a long timeline query (ie, 30+ days back)</li>
	<li>You can access other sections of DrProject when the timeline is locking up (ie, the Wiki)</li>
	<li>The DrProject log for the hanging request cuts off while the timeline is gathering events for the Ticket system.  Note that there are 5 subsystems that the timeline gathers events for, and the Ticket system is the last of these.</li>
	<li>Multiple requests for the same URL will cause the process to hang at the same point during collection!</li>
</ul>
After some time, DrProject will stop locking up for these timeline requests and the service returns to normal, albeit with a number of hung processes/connections on the server.

I tried an experiment whereby I inserted a manual <code>gc.collect()</code> call into the timeline code.  I verified that with the manual cleanup, the timeline would process normally, and that without the cleanup, it would continue to hang (I switched between these two multiple times, so as to rule out an accidental solution ;))

Continuing in this vein, I started to investigate whether there were any objects not being collected properly (in particular, leftover database connection objects would worry me).  Sure enough, a number of PooledConnection objects are classified as uncollectable by the Python garbage collector.  In the simplest form, the problem seems to be isolated to the 'select' function in our generic <code>Record</code> class.  This class is the base class in our custom Object/Relational mapping framework, and implements the basic SELECT functionality for every object.  The following example shows the problem:
<blockquote>
<pre>from drproject.env import Environment from drproject.project import Project import gc gc.set_debug(gc.DEBUG_LEAK)  env = Environment('/tmp/drproject') for obj in Project.select(env, 'All'): print str(obj)</pre>
</blockquote>
Which results in the following output:
<blockquote>
<pre>... &lt;Project name='All'&gt; ... gc: collectable &lt;EntryPoint 0x1256f50&gt; gc: collectable &lt;dict 0x125c030&gt; gc: collectable &lt;tuple 0x1256e70&gt; gc: collectable &lt;list 0x434fa8&gt; gc: collectable &lt;cell 0x43f770&gt; gc: collectable &lt;cell 0x43f870&gt; gc: collectable &lt;cell 0x43f710&gt; gc: collectable &lt;function 0x41c630&gt; gc: collectable &lt;tuple 0x1251cd8&gt; gc: collectable &lt;tuple 0x43f510&gt; gc: uncollectable &lt;PooledConnection 0x434e18&gt; gc: uncollectable &lt;dict 0x4a5ed0&gt;</pre>
</blockquote>
<strong>Note:</strong> The dict that is uncollectable is actually the __dict__ object for the PooledConnection that is uncollectable.

My working theory is that during a long timeline request, these uncollectable PooledConnection objects accumulate to the point where Python will hang unless a manual collection is done.  This fails to explain, however, why the timeline is locking up in rare occasions, and not all the time.

My next step will be attaching GDB to one of the frozen processes to see exactly what is going on.  As I've never done this before, it should be a good learning experience ;)

--- Sean Dawson

                


              </div>
            </div>
            <div class="pagination">
              
              <a class="btn btn-default" href="/2006/03/29/png-transparency-and-printing-grief.html" class="next">Newer</a>
              
              
              <a class="btn btn-default" href="/2006/03/27/the-real-convergence.html" class="previous">Older</a>
              
            </div>
            
            
            <div class="well">
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
            
            
          </div>
        </div>
      </div>
    </div>
    
  <script type="text/javascript">
    var disqus_shortname = 'thirdbit';

    var disqus_config = function () {
        this.page.identifier = '2006-03-29-showstopper-hanging-processes-html';
    };

   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    <div class="container-fluid">
  <div class="row-fluid">
    <div class="span12 footer navbar-inverse navbar-fixed-bottom">
      <br/>
      <p class="copyright">
        &copy; 2018 Greg Wilson.
        All content made available under the <a href="/license/">Creative Commons - Attribution License</a>.
      </p>
    </div>
  </div>
</div>


  <script type="text/javascript">
    var disqus_shortname = 'thirdbit';

    var disqus_config = function () {
        this.page.identifier = '2006-03-29-showstopper-hanging-processes-html';
    };

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>



  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1301159-1', 'auto');
    ga('send', 'pageview');
  </script>



</body>
</html>

  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/theme.js"></script>
<link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/css/theme.css" rel="stylesheet" type="text/css">
<link href="/css/syntax.css" rel="stylesheet" type="text/css">



    <title>Third Bit: Testing Image Processing</title>
  </head>
  <body>
    <div class="container-fluid">
  <div class="row-fluid">
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Third Bit</a>
      </div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <li class="active visible-xs-block"><a href="/links/">Links</a></li>
          <li class="active"><a href="/about/">About</a></li>
          <li class="active"><a href="/talks/">Talks</a></li>
          <li class="active"><a href="/ideas/">Ideas</a></li>
          <li class="active"><a href="/reading/">Reading</a></li>
          <li class="active"><a href="/archive/">Archive</a></li>
          <li class="active"><a href="/teaching/"><em>How to Teach</em></a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li class="active"><a href="http://appear.in/gvwilson"><img src="/files/appear.in.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="https://github.com/gvwilson"><img src="/files/github.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="http://twitter.com/gvwilson"><img src="/files/twitter.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="/feed.xml"><img src="/files/rss.svg" class="navbar-icon" /></a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

    <div class="container container-left">
      <div class="row">
        <div class="col-md-3 hidden-xs">
          <div class="sidebar well">
  <h2>Links</h2>
<p><em><a href="http://software-carpentry.org">Software Carpentry</a></em></p>
<p><em><a href="http://aosabook.org">Architecture of Open Source Applications</a></em></p>
<p><em><a href="http://neverworkintheory.org">Never Work in Theory</a></em></p>
<p><em><a href="http://sensibleadventures.com">Sensible Adventures</a></em></p>
<p><a href="/cv/">CV</a></p>
<p><a href="/bib/">Bibliography</a></p>

  <h2>Favorites</h2>
  
  
  <p><a href="/2018/03/20/goodbye-jeff.html">Goodbye, Jeff</a></p>
  
  <p><a href="/2018/03/16/seven-ways.html">Seven Ways to Think Like a Programmer</a></p>
  
  <p><a href="/2018/03/13/base-case-for-empirical-software-engineering.html">A Base Case for Empirical Software Engineering Research</a></p>
  
  <p><a href="/2018/01/07/book-club.html">Book Club</a></p>
  
  <p><a href="/2017/12/21/talking-people-into-things.html">Ten Simple Rules for Talking People Into Things</a></p>
  
  <p><a href="/2017/11/05/for-everyone.html">Carpentry For Everyone</a></p>
  
  <p><a href="/2017/10/16/exercise-types.html">What Kinds of Exercises Do You Use to Teach Programming?</a></p>
  
  <p><a href="/2017/09/30/git-graphs-and-engineering.html">Git, Graphs, and Software Engineering</a></p>
  
  <p><a href="/2017/06/19/ten-rules-research-partner.html">Ten Simple Rules for Being a Good Research Partner</a></p>
  
  <p><a href="/2017/05/22/numerical-javascript.html">Numerical JavaScript</a></p>
  
  <p><a href="/2017/01/06/them-thats-got.html">Them That's Got</a></p>
  
  <p><a href="/2016/10/30/rules-for-teaching.html">Rules for Teaching</a></p>
  
  <p><a href="/2016/04/29/why-teachers-dont-collaborate.html">Why Teachers Don't Collaborate on Lesson Development</a></p>
  
  <p><a href="/2016/04/01/zen-and-the-art-of-assignment-operators.html">Zen and the Art of Assignment Operators</a></p>
  
  <p><a href="/2016/03/13/in-my-better-world.html">In My Better World</a></p>
  
  <p><a href="/2015/12/19/why-i-teach.html">Why I Teach (Revisited)</a></p>
  
  <p><a href="/2015/12/06/just-keep-swimming.html">Just Keep Swimming</a></p>
  
  <p><a href="/2015/11/29/exaptation.html">Exaptation and the Future of Software Engineering</a></p>
  
  <p><a href="/2015/11/09/daddy-why-dont-you-ever-laugh.html">Daddy, Why Don't You Ever Laugh?</a></p>
  
  <p><a href="/2015/09/22/dad.html">Goodbye, Dad</a></p>
  
  <p><a href="/2014/10/08/announcing-the-creation-of-the-software-carpentry-foundational.html">Announcing the Creation of the Software Carpentry Foundation</a></p>
  
  <p><a href="/2014/03/14/learning-at-scale.html">Is Learning at Scale Just Another Name for Ubiquitous Surveillance in the Classroom?</a></p>
  
  <p><a href="/2013/10/17/you-keep-using-that-word.html">You Keep Using That Word</a></p>
  
  <p><a href="/2013/02/11/correctness-isnt-compelling.html">Correctness Isn't Compelling</a></p>
  
  <p><a href="/2012/10/23/twenty-percent.html">Twenty Percent</a></p>
  
  <p><a href="/2012/06/29/those-who-ignore-history.html">That Seems Simple to Me</a></p>
  
  <p><a href="/2012/01/21/the-life-i-did-live-the-breath-i-breathed.html">We Have Nothing To Give Them</a></p>
  
</div>

        </div>
        <div class="col-md-9">
          <div class="article">
            <div class="well">
              <h1><a href="/2013/03/17/testing-image-processing.html">Mar 17, 2013 - Testing Image Processing</a></h1>
              <div class="post-content">
                <p>
  <a href="/lessons/previous/#test">Testing</a> has always been part of Software Carpentry,
  but it's also always been one of our weak spots.
  We explain that testing can't possibly uncover all the mistakes in a piece of software,
  but is useful anyway, then talk about unit testing and test-driven development.
  Separately,
  in the <a href="/lessons/previous/#invperc">extended program design example</a>,
  we demonstrate how to refactor code to make it more testable.
</p>
<p>
  What we <em>don't</em> do is show people how to test the science-y bits of scientific software.
  More specifically,
  our current material doesn't contain a single example showing how to check
  the correctness of something that does floating-point.
  You won't find much mention of this in books and articles aimed at mainstream programmers either:
  most just say, "Oh, round-off,"
  then tell you to use an <code>almostEquals</code> assertion with a tolerance,
  without telling you how to decide what the tolerance should be,
  or what to do when your result is a vector or matrix rather than a single scalar value.
</p>
<p>
  I'd like to fix this, but there's a constraint:
  whatever examples we use must be comprehensible to everyone we're trying to reach.
  That rules out anything that depends on knowing how gamma functions are supposed to behave,
  or what approximations can be used to give upper and lower bounds on advection in fluids with high Reynolds numbers.
  What <em>might</em> work is simple image processing:
</p>
<ol>
  <li>
    It's easy to see what's going on
    (though using this for our examples does create even higher barriers for the visually impaired).
  </li>
  <li>
    There are a lot of simple algorithms to test that can go wrong in interesting, plausible ways.
  </li>
  <li>
    We're planning to shift our intro to Python to be media-based anyway
    (using Matt Davis's <a href="https://pypi.python.org/pypi/ipythonblocks">ipythonblocks</a>
    and Mike Hansen's <a href="https://github.com/synesthesiam/scikit-image/tree/master/skimage/novice">novice</a> submodule
    for <a href="https://github.com/scikit-image/scikit-image">scikit-image</a>).
  </li>
  <li>
    People can learn something useful while they're learning about testing.
  </li>
</ol>
<p>
  How do experts test image processing code?
  According to Steve Eddins,
  who writes image processing code at The MathWorks
  and blogged about a <a href="http://blogs.mathworks.com/steve/2013/03/12/matlab-software-testing-tools-old-and-new-r2013a/">new testing framework for MATLAB</a>
  a few days ago:
</p>
<blockquote>
  <p>
    Whenever there is a floating-point computation that is then quantized to produce an output image,
    comparing actual versus expected can be tricky.
    I had to learn to deal with this early in my MathWorks software developer days.
    Two common scenarios in which this occurs:
  </p>
  <ul>
    <li>Rounding a floating-point computation to produce an integer-valued output image</li>
    <li>Thresholding a floating-point computation to produce a binary image (such as many edge detection methods)</li>
  </ul>
  <p>
    The problem is that floating-point round-off differences  can turn a floating-point value
    that should be a 0.5 or exactly equal to the threshold into a value that's a tiny bit below.
    For testing, this means that the actual and expected images are exactly the same...except
    for a small number of pixels that are off by one.
  </p>
  <p>
    In a situation like this,
    the actual image can change because you changed the compiler's optimization flags,
    used a different compiler,
    used a different processor,
    used a multithreaded algorithm with dynamic allocation of work to the different threads,
    etc.
    So to compare actual against expected,
    I wrote a test assertion function that passes if the actual is the same as the expected
    except for a small percentage of pixels that are allowed to be different by 1.
  </p>
</blockquote>
<p>
  All right,
  but how do you decide how many is "a small percentage"?
  Quoting Steve again:
</p>
<blockquote>
  <p>
    There isn't a general rule.
    With filtering, for example,
    some choices of filter coefficients could lead to a lot of "int + 0.5" values;
    other coefficients might result in few or none.
  </p>
  <p>
    I start with either an exact equality test or a floating-point tolerance test,
    depending on the computation.
    If there are some off-by-one values,
    I spot-check them to verify whether they are caused by a floating-point round-off plus quantization issue.
    If it all looks good,
    then I set the tolerance based on what's happening in that particular test case and move on.
    If you tied me down and forced me to pick a typical number,
    I'd say 1%.
  </p>
  <p>
    Perhaps not a very satisfying answer...
  </p>
</blockquote>
<p>
  To which I replied:
</p>
<blockquote>
  <p>
    This is a great answer,
    because it mirrors what scientists do with physical lab experiments:
  </p>
  <ul>
    <li>Get a result.</li>
    <li>Go through the differences between actual and expected to see if they can explain/understand "why".</li>
    <li>Make a note of their tolerances for future re-use.</li>
  </ul>
</blockquote>
<p>
  As we say in our classes,
  programs ought to be treated like any other kind of experimental apparatus.
  My question now is,
  what rules of thumb do <em>you</em> have for testing the science-y bits of your code?
  We'd welcome replies as comments or <a href="mailto:">email</a>.
</p>

                <p align="center"><em>This post originally appeared in the <a href="http://software-carpentry.org">Software Carpentry</a> blog.</em></p>


              </div>
            </div>
            <div class="pagination">
              
              <a class="btn btn-default" href="/2013/03/24/comments-on-firefox-available-for-analysis.html" class="next">Newer</a>
              
              
              <a class="btn btn-default" href="/2013/03/17/cumulative-enrollment.html" class="previous">Older</a>
              
            </div>
            
            
            <div class="well">
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
            
            
          </div>
        </div>
      </div>
    </div>
    
  <script type="text/javascript">
    var disqus_shortname = 'thirdbit';

    var disqus_config = function () {
        this.page.identifier = '2013-03-17-testing-image-processing-html';
    };

   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    <div class="container-fluid">
  <div class="row-fluid">
    <div class="span12 footer navbar-inverse navbar-fixed-bottom">
      <br/>
      <p class="copyright">
        &copy; 2018 Greg Wilson.
        All content made available under the <a href="/license/">Creative Commons - Attribution License</a>.
      </p>
    </div>
  </div>
</div>


  <script type="text/javascript">
    var disqus_shortname = 'thirdbit';

    var disqus_config = function () {
        this.page.identifier = '2013-03-17-testing-image-processing-html';
    };

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>



  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1301159-1', 'auto');
    ga('send', 'pageview');
  </script>



</body>
</html>

  </body>
</html>
